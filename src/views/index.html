<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.4/css/dataTables.semanticui.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Exo+2:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ .AppBasePath }}/assets/app.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.4/js/dataTables.semanticui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.8/semantic.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <title>Whats Connect Api {{ .AppVersion }}</title>
</head>
<body>

<!-- ===================== SPLASH ===================== -->
<div id="splash-screen">
    <img src="{{ .AppBasePath }}/assets/gowca.svg" alt="Logo" class="splash-icon" id="main-logo">
    <h2 class="splash-title">Whats Connect Api</h2>
    <p class="splash-subtitle">// INICIALIZANDO SISTEMA</p>
    <div class="ui active large inline loader splash-spinner"></div>
</div>

<!-- ===================== APP ===================== -->
<div class="ui container main-content-wrap" id="app" style="display: none;">

    <!-- HEADER -->
    <div class="main-header">
        <div class="header-top-bar"></div>
        <div class="header-scanline"></div>
        <div class="header-inner">
            <h1 class="ui header center aligned">
                <div class="title-container">
                    <div class="title-logo-wrap">
                        <img src="{{ .AppBasePath }}/assets/gowca.svg" alt="Logo">
                    </div>
                    <div class="title-text-group">
                        <span class="title-main">Whats Connect Api</span>
                    </div>
                    <div class="version-label">{{ .AppVersion }}</div>
                </div>
            </h1>
        </div>
    </div>

    <!-- DEVICE CONTEXT ALERT -->
    <div class="ui info message" v-if="selectedDeviceId">
        <div class="header">
            <i class="linkify icon"></i>
            Contexto do dispositivo ativo
        </div>
        <p>
            Usando o dispositivo: <b>[[ selectedDeviceId ]]</b>.
            Envie via REST/WebSocket com <code>X-Device-Id</code> (ou <code>?device_id=</code> para WS).
        </p>
    </div>

    <!-- DEVICE MANAGER -->
    <device-manager
        ref="deviceManager"
        ws-base-path="{{ .AppBasePath }}"
        @device-selected="handleDeviceSelected"
        @devices-updated="handleDevicesUpdated">
    </device-manager>

    <div class="ui horizontal divider section-divider">▸ Aplicativo</div>

    <div class="ui warning message" v-if="!selectedDeviceId">
        <div class="header">Dispositivo necessário</div>
        <p>Selecione ou crie um dispositivo acima. Forneça <code>X-Device-Id</code> nas chamadas REST.</p>
    </div>

    <div class="ui three column stackable centered grid cards" :class="{disabled: !selectedDeviceId}">
        <app-login :logged-in="isSelectedDeviceLoggedIn"></app-login>
        <app-logout @reload-devices="handleReloadDevice"></app-logout>
        <app-reconnect @reload-devices="handleReloadDevice"></app-reconnect>
        <app-login-with-code :logged-in="isSelectedDeviceLoggedIn"></app-login-with-code>
    </div>

    <div class="ui horizontal divider">▸ Enviar</div>

    <div class="ui three column doubling centered grid cards">
        <send-message></send-message>
        <send-image></send-image>
        <send-file max-file-size="{{ .MaxFileSize }}"></send-file>
        <send-video max-video-size="{{ .MaxVideoSize }}"></send-video>
        <send-sticker></send-sticker>
        <send-contact></send-contact>
        <send-location></send-location>
        <send-audio></send-audio>
        <send-poll></send-poll>
        <send-presence></send-presence>
        <send-chat-presence></send-chat-presence>
        <send-link></send-link>
    </div>

    <div class="ui horizontal divider">▸ Mensagem</div>

    <div class="ui three column doubling centered grid cards">
        <message-delete></message-delete>
        <message-revoke></message-revoke>
        <message-react></message-react>
        <message-update></message-update>
        <message-read></message-read>
    </div>

    <div class="ui horizontal divider">▸ Grupo</div>

    <div class="ui three column doubling centered grid cards">
        <group-list :connected="connected_devices"></group-list>
        <group-create></group-create>
        <group-join-with-link></group-join-with-link>
        <group-info-from-link></group-info-from-link>
        <group-add-participants></group-add-participants>
        <group-set-photo></group-set-photo>
        <group-set-name></group-set-name>
        <group-set-locked></group-set-locked>
        <group-set-announce></group-set-announce>
        <group-set-topic></group-set-topic>
        <group-get-invite-link></group-get-invite-link>
        <group-info></group-info>
    </div>

    <div class="ui horizontal divider">▸ Boletim informativo</div>

    <div class="ui three column doubling centered grid cards">
        <newsletter-list></newsletter-list>
    </div>

    <div class="ui horizontal divider">▸ Conta</div>

    <div class="ui three column doubling centered grid cards">
        <account-avatar></account-avatar>
        <account-change-avatar></account-change-avatar>
        <account-change-push-name></account-change-push-name>
        <account-user-info></account-user-info>
        <account-business-profile></account-business-profile>
        <account-privacy></account-privacy>
        <account-contact></account-contact>
        <account-user-check></account-user-check>
    </div>

    <div class="ui horizontal divider">▸ Gerenciamento de Conversa</div>

    <div class="ui three column doubling centered grid cards">
        <chat-pin-manager></chat-pin-manager>
        <chat-disappearing-manager></chat-disappearing-manager>
        <chat-list></chat-list>
        <chat-messages></chat-messages>
    </div>

</div>

<!-- ===================== FOOTER FIXO ===================== -->
<footer class="app-footer">
    <div class="footer-inner">
        <span class="footer-dot"></span>
        <span class="footer-text">
            Desenvolvido por <strong class="footer-dev">Andredye Oliveira Melo</strong>
        </span>
        <span class="footer-dot"></span>
    </div>
</footer>

<!-- ===================== JS (inalterado) ===================== -->
<script>
    window.TYPEGROUP = "@g.us";
    window.TYPEUSER = "@s.whatsapp.net";
    window.TYPENEWSLETTER = "@newsletter";
    window.TYPESTATUS = "status@broadcast";
    window.showErrorInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Erro',
            message: message,
            showProgress: 'bottom',
            classProgress: 'red'
        });
    }
    window.showSuccessInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Sucesso',
            message: message,
            showProgress: 'bottom',
            classProgress: 'green'
        });
    }

    const baseHost = `${window.location.protocol}//${window.location.hostname}${window.location.port ? ':' + window.location.port : ''}`;
    const DEVICE_ID_HEADER = 'X-Device-Id';
    window.http = axios.create({
        baseURL: `${baseHost}{{ .AppBasePath }}`
    });
    {{ if isEnableBasicAuth .BasicAuthToken }}
    window.http.defaults.headers.common['Authorization'] = "{{ .BasicAuthToken }}";
    {{ end }}
</script>
<script type="module">
    import AppLogin from "{{ .AppBasePath }}/components/AppLogin.js";
    import AppLoginWithCode from "{{ .AppBasePath }}/components/AppLoginWithCode.js";
    import AppLogout from "{{ .AppBasePath }}/components/AppLogout.js";
    import AppReconnect from "{{ .AppBasePath }}/components/AppReconnect.js";
    import SendMessage from "{{ .AppBasePath }}/components/SendMessage.js";
    import SendImage from "{{ .AppBasePath }}/components/SendImage.js";
    import SendFile from "{{ .AppBasePath }}/components/SendFile.js";
    import SendVideo from "{{ .AppBasePath }}/components/SendVideo.js";
    import SendSticker from "{{ .AppBasePath }}/components/SendSticker.js";
    import SendLink from "{{ .AppBasePath }}/components/SendLink.js";
    import SendContact from "{{ .AppBasePath }}/components/SendContact.js";
    import SendLocation from "{{ .AppBasePath }}/components/SendLocation.js";
    import SendAudio from "{{ .AppBasePath }}/components/SendAudio.js";
    import SendPoll from "{{ .AppBasePath }}/components/SendPoll.js";
    import SendPresence from "{{ .AppBasePath }}/components/SendPresence.js";
    import SendChatPresence from "{{ .AppBasePath }}/components/SendChatPresence.js";
    import MessageDelete from "{{ .AppBasePath }}/components/MessageDelete.js";
    import MessageUpdate from "{{ .AppBasePath }}/components/MessageUpdate.js";
    import MessageReact from "{{ .AppBasePath }}/components/MessageReact.js";
    import MessageRevoke from "{{ .AppBasePath }}/components/MessageRevoke.js";
    import MessageRead from "{{ .AppBasePath }}/components/MessageRead.js";
    import GroupList from "{{ .AppBasePath }}/components/GroupList.js";
    import GroupCreate from "{{ .AppBasePath }}/components/GroupCreate.js";
    import GroupJoinWithLink from "{{ .AppBasePath }}/components/GroupJoinWithLink.js";
    import GroupInfoFromLink from "{{ .AppBasePath }}/components/GroupInfoFromLink.js";
    import GroupAddParticipants from "{{ .AppBasePath }}/components/GroupManageParticipants.js";
    import GroupSetPhoto from "{{ .AppBasePath }}/components/GroupSetPhoto.js";
    import GroupSetName from "{{ .AppBasePath }}/components/GroupSetName.js";
    import GroupSetLocked from "{{ .AppBasePath }}/components/GroupSetLocked.js";
    import GroupSetAnnounce from "{{ .AppBasePath }}/components/GroupSetAnnounce.js";
    import GroupSetTopic from "{{ .AppBasePath }}/components/GroupSetTopic.js";
    import GroupGetInviteLink from "{{ .AppBasePath }}/components/GroupGetInviteLink.js";
    import GroupInfo from "{{ .AppBasePath }}/components/GroupInfo.js";
    import NewsletterList from "{{ .AppBasePath }}/components/NewsletterList.js";
    import AccountAvatar from "{{ .AppBasePath }}/components/AccountAvatar.js";
    import AccountChangeAvatar from "{{ .AppBasePath }}/components/AccountChangeAvatar.js";
    import AccountChangePushName from "{{ .AppBasePath }}/components/AccountChangePushName.js";
    import AccountUserInfo from "{{ .AppBasePath }}/components/AccountUserInfo.js";
    import AccountPrivacy from "{{ .AppBasePath }}/components/AccountPrivacy.js";
    import AccountContact from "{{ .AppBasePath }}/components/AccountContact.js";
    import AccountUserCheck from "{{ .AppBasePath }}/components/AccountUserCheck.js";
    import AccountBusinessProfile from "{{ .AppBasePath }}/components/AccountBusinessProfile.js";
    import ChatPinManager from "{{ .AppBasePath }}/components/ChatPinManager.js";
    import ChatDisappearingManager from "{{ .AppBasePath }}/components/ChatDisappearingManager.js";
    import ChatList from "{{ .AppBasePath }}/components/ChatList.js";
    import ChatMessages from "{{ .AppBasePath }}/components/ChatMessages.js";
    import DeviceManager from "{{ .AppBasePath }}/components/DeviceManager.js";

    const showErrorInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Erro',
            message: message,
            showProgress: 'bottom',
            classProgress: 'red'
        });
    }
    const showSuccessInfo = (message) => {
        $('body').toast({
            position: 'bottom right',
            title: 'Sucesso',
            message: message,
            showProgress: 'bottom',
            classProgress: 'green'
        });
    }

    Vue.createApp({
        components: {
            AppLogin, AppLoginWithCode, AppLogout, AppReconnect,
            SendMessage, SendImage, SendFile, SendVideo, SendSticker, SendLink, SendContact, SendLocation, SendAudio, SendPoll, SendPresence, SendChatPresence,
            MessageDelete, MessageUpdate, MessageReact, MessageRevoke, MessageRead,
            GroupList, GroupCreate, GroupJoinWithLink, GroupInfoFromLink, GroupAddParticipants, GroupSetPhoto, GroupSetName, GroupSetLocked, GroupSetAnnounce, GroupSetTopic, GroupGetInviteLink, GroupInfo,
            NewsletterList,
            AccountAvatar, AccountUserInfo, AccountPrivacy, AccountChangeAvatar, AccountContact, AccountChangePushName, AccountUserCheck, AccountBusinessProfile,
            ChatPinManager, ChatDisappearingManager, ChatList, ChatMessages,
            DeviceManager
        },
        delimiters: ['[[', ']]'],
        data() {
            return {
                app_ws: null,
                connected_devices: null,
                deviceList: [],
                selectedDeviceId: '',
            }
        },
        computed: {
            selectedDevice() {
                if (!this.selectedDeviceId) return null;
                return this.deviceList.find(d => (d.id || d.device) === this.selectedDeviceId) || null;
            },
            isSelectedDeviceLoggedIn() {
                return this.selectedDevice?.state === 'logged_in';
            },
        },
        methods: {
            applyDeviceHeader(id) {
                if (id) {
                    window.http.defaults.headers.common[DEVICE_ID_HEADER] = encodeURIComponent(id);
                } else {
                    delete window.http.defaults.headers.common[DEVICE_ID_HEADER];
                    if (this.app_ws) {
                        this.app_ws.close();
                        this.app_ws = null;
                    }
                }
            },
            constructWebSocketURL() {
                if (!this.selectedDeviceId) return '';
                const protocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
                const basePath = '{{ .AppBasePath }}';
                const deviceQuery = encodeURIComponent(this.selectedDeviceId);
                const pathPrefix = basePath || '';
                return `${protocol}${location.host}${pathPrefix}/ws?device_id=${deviceQuery}`;
            },
            handleReloadDevice() {
                if (this.$refs.deviceManager) {
                    this.$refs.deviceManager.refresh();
                }
                if (this.app_ws) {
                    this.app_ws.send(JSON.stringify({"code": "FETCH_DEVICES"}));
                }
            },
            handleDeviceSelected(id) {
                this.selectedDeviceId = id;
                this.applyDeviceHeader(id);
                if (id) {
                    this.connectWebSocket();
                }
            },
            handleDevicesUpdated(devices) {
                this.deviceList = devices;
                this.connected_devices = devices;
            },
            connectWebSocket() {
                if (!this.selectedDeviceId) return;
                if (this.app_ws) {
                    this.app_ws.close();
                    this.app_ws = null;
                }
                const wsURL = this.constructWebSocketURL();
                if (!wsURL) return;
                this.app_ws = new WebSocket(wsURL);
                this.app_ws.onopen = (evt) => { this.handleReloadDevice(); };
                this.app_ws.onerror = (error) => {
                    console.error('Erro no WebSocket:', error);
                    if (this.isSelectedDeviceLoggedIn) {
                        showErrorInfo('Ocorreu um erro de conexão. Atualize ou selecione novamente o dispositivo.');
                    }
                };
                this.app_ws.onmessage = (evt) => {
                    const message = JSON.parse(evt.data)
                    switch (message.code) {
                        case 'LOGIN_SUCCESS':
                            showSuccessInfo('Sucesso no Login: ' + message.message)
                            $('#modalLogin').modal('hide');
                            this.handleReloadDevice()
                            break;
                        case 'LIST_DEVICES':
                            this.connected_devices = message.result
                            break;
                        case 'LOGOUT_COMPLETE':
                            showSuccessInfo('✅ Logout completo: ' + message.message)
                            this.handleReloadDevice()
                            break;
                        case 'DEVICE_REMOVED': {
                            const removedId = message.result?.device_id;
                            const devices = message.result?.devices;
                            showSuccessInfo('✅ ' + (message.message || 'Dispositivo removido'));
                            if (Array.isArray(devices)) {
                                this.deviceList = devices;
                                this.connected_devices = devices;
                                if (removedId && this.selectedDeviceId === removedId) {
                                    this.selectedDeviceId = '';
                                    this.applyDeviceHeader('');
                                }
                                if (!this.selectedDeviceId && this.deviceList.length > 0) {
                                    const first = this.deviceList[0].id || this.deviceList[0].device;
                                    this.setDeviceContext(first);
                                }
                            } else {
                                this.handleReloadDevice();
                            }
                            break;
                        }
                        default:
                            console.log(message)
                    }
                };
            },
        },
        mounted() {
            setTimeout(() => {
                document.getElementById('app').style.display = 'block';
                document.getElementById('splash-screen').classList.add('fade-out');
            }, 800);
        },
    }).mount('#app')
</script>
</body>
</html>